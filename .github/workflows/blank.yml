name: COBOL Full CICD

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:

  # 1) SECURITY SCAN
  security_scan:
    name: Security Scan (Trivy)
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Trivy
        run: |
          sudo apt-get update -y
          sudo apt-get install wget -y
          wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.50.0_Linux-64bit.deb
          sudo dpkg -i trivy_0.50.0_Linux-64bit.deb

      - name: Run Trivy on source code
        run: trivy fs . --exit-code 0 --no-progress

  # 2) PARALLEL BUILD + DB MIGRATION
  build_and_migrate:
    name: Parallel: Build COBOL App + DB Migration
    runs-on: self-hosted
    needs: security_scan

    strategy:
      matrix:
        jobtype: [build, migrate]

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install required tools
        run: sudo apt-get install -y gnu-cobol dos2unix postgresql-client unzip

      - name: Build COBOL executable (Linux)
        if: matrix.jobtype == 'build'
        run: |
          dos2unix scripts/build.sh
          bash scripts/build.sh

      - name: Run DB Migrations on PostgreSQL
        if: matrix.jobtype == 'migrate'
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASS: ${{ secrets.DB_PASS }}
          DB_NAME: ${{ secrets.DB_NAME }}
        run: |
          dos2unix scripts/db_migrate.sh
          bash scripts/db_migrate.sh

  # 3) PUSH BUILD OUTPUT TO NEXUS
  push_to_nexus:
    name: Push Executable to Nexus Repository
    runs-on: self-hosted
    needs: build_and_migrate

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Upload COBOL binary to Nexus
        env:
          NEXUS_IP: ${{ secrets.NEXUS_IP }}
          NEXUS_USER: ${{ secrets.NEXUS_USER }}
          NEXUS_PASS: ${{ secrets.NEXUS_PASS }}
        run: |
          curl -v -u "$NEXUS_USER:$NEXUS_PASS" \
            --upload-file output/cobol-app \
            "http://$NEXUS_IP:8081/repository/cobol-release/cobol-app"

  # 4) DEPLOY TO EC2
  deploy_to_ec2:
    name: Deploy to EC2 Linux (runner)
    runs-on: self-hosted
    needs: push_to_nexus

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Deploy Latest Build
        env:
          NEXUS_IP: ${{ secrets.NEXUS_IP }}
          NEXUS_USER: ${{ secrets.NEXUS_USER }}
          NEXUS_PASS: ${{ secrets.NEXUS_PASS }}
        run: |
          dos2unix scripts/deploy.sh
          bash scripts/deploy.sh

  # 5) SMOKE TEST
  smoke_test:
    name: Smoke Test Application
    runs-on: self-hosted
    needs: deploy_to_ec2

    steps:
      - name: Test Health Endpoint
        run: |
          curl -I http://localhost:8080/health || exit 1
